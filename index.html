<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1" name="viewport"/>
  <title>OneClash WiFi Store</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet"/>
  <style>
    body {
      font-family: 'Roboto Mono', monospace;
      background-color: #ffffff;
      color: #0f172a;
    }
    .nav-btn {
      background-color: transparent;
      border: 2px solid #3b82f6;
      color: #3b82f6;
      font-weight: 700;
      transition: all 0.3s ease;
      border-radius: 0.75rem;
      padding-left: 1.5rem;
      padding-right: 1.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .nav-btn:hover, .nav-btn:focus {
      background: #3b82f6;
      color: #ffffff;
      box-shadow: 0 0 10px #3b82f6;
      outline: none;
      transform: translateY(-3px);
    }
    .btn-primary {
      background: linear-gradient(90deg, #2563eb, #1e40af);
      box-shadow: 0 4px 15px rgb(37 99 235 / 0.6);
      font-weight: 700;
      transition: all 0.3s ease;
      color: white;
      border-radius: 0.75rem;
      padding-left: 1.25rem;
      padding-right: 1.25rem;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 1rem;
    }
    .btn-primary:hover, .btn-primary:focus {
      background: linear-gradient(90deg, #1e40af, #2563eb);
      box-shadow: 0 6px 20px rgb(37 99 235 / 0.8);
      outline: none;
      transform: translateY(-3px);
      color: white;
    }
    .card {
      background: #f9fafb;
      border-radius: 1.5rem;
      box-shadow: 0 8px 30px rgb(59 130 246 / 0.1);
      position: relative;
      overflow: hidden;
      border: 1px solid #3b82f6;
      color: #0f172a;
    }
    .card::before {
      content: '';
      position: absolute;
      top: -60%;
      left: -60%;
      width: 220%;
      height: 220%;
      background: linear-gradient(135deg, transparent 30%, #3b82f6 50%, transparent 70%);
      transform: rotate(25deg);
      opacity: 0.07;
      pointer-events: none;
      z-index: 0;
      animation: shimmer 6s linear infinite;
    }
    @keyframes shimmer {
      0% {
        transform: rotate(25deg) translateX(-100%);
      }
      100% {
        transform: rotate(25deg) translateX(100%);
      }
    }
    .history-item {
      background: #f3f4f6;
      border: 2px solid #e2e8f0;
      border-radius: 0.75rem;
      padding: 1rem 1.5rem;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: #0f172a;
    }
    .history-item:hover, .history-item:focus {
      background: #f3f4f6;
      color: #0f172a;
      box-shadow: none;
      outline: none;
      transform: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
    }
    footer {
      color: #64748b;
      font-weight: 500;
      user-select: none;
    }
    footer i {
      color: #ef4444;
    }
    #historyList {
      max-height: 400px;
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: #3b82f6 transparent;
    }
    #historyList::-webkit-scrollbar {
      width: 8px;
    }
    #historyList::-webkit-scrollbar-track {
      background: transparent;
    }
    #historyList::-webkit-scrollbar-thumb {
      background-color: #3b82f6;
      border-radius: 4px;
    }
    .modal-content {
      background: #f9fafb;
      border-radius: 1.5rem;
      box-shadow: 0 10px 40px rgb(37 99 235 / 0.15);
      color: #0f172a;
      max-width: 400px;
      width: 100%;
      padding: 2rem;
      position: relative;
    }
    .modal-content h3 {
      font-weight: 700;
      font-size: 1.25rem;
      margin-bottom: 1.5rem;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 0.75rem;
      color: #2563eb;
    }
    .modal-content button {
      width: 100%;
    }
    .modal-content img {
      border-radius: 1rem;
      border: 2px solid #3b82f6;
      box-shadow: 0 0 15px #3b82f6;
    }
    .select-all {
      user-select: all;
    }
    .location-text {
      font-size: 0.75rem;
      color: #475569;
      font-weight: 500;
    }
    .nav-btn.rounded-corners {
      border-radius: 0.75rem;
    }
    @media (max-width: 640px) {
      nav {
        flex-direction: column;
        gap: 1rem;
      }
      .history-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
      }
      .history-item > div:last-child {
        align-self: flex-end;
      }
    }

    /* New styles for radio dropdown and email input */
    @keyframes slideIn {
      from {
        transform: translateY(-10px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }
    .duration-dropdown {
      position: relative;
    }
    .duration-options {
      position: absolute;
      width: 100%;
      margin-top: 0.5rem;
      border-radius: 1rem;
      background: white;
      border: 2px solid #3b82f6;
      box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
      z-index: 50;
      max-height: 24rem;
      overflow-y: auto;
      animation: slideIn 0.2s ease-out;
    }
    .duration-option {
      display: flex;
      align-items: center;
      padding: 1rem;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .duration-option:hover {
      background-color: #f0f9ff;
    }
    .duration-option.selected {
      background-color: #e0f2fe;
    }
    .custom-radio {
      width: 1.5rem;
      height: 1.5rem;
      border: 2px solid #3b82f6;
      border-radius: 9999px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 1rem;
      flex-shrink: 0;
    }
    .custom-radio-inner {
      width: 0.75rem;
      height: 0.75rem;
      background-color: #3b82f6;
      border-radius: 9999px;
      opacity: 0;
      transition: opacity 0.2s;
    }
    .duration-option.selected .custom-radio-inner {
      opacity: 1;
    }
    .duration-label {
      font-weight: 600;
      color: #1e3a8a;
    }
    .duration-price {
      font-size: 0.875rem;
      color: #3b82f6;
    }
    .dropdown-button {
      width: 100%;
      border-radius: 0.75rem;
      border: 2px solid #3b82f6;
      background: white;
      padding: 1rem 1.25rem;
      font-weight: 600;
      text-align: left;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.3s ease;
    }
    .dropdown-button:hover {
      border-color: #2563eb;
    }
    .dropdown-button:focus {
      outline: none;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
      border-color: #2563eb;
    }
    .dropdown-icon {
      transition: transform 0.2s;
    }
    .dropdown-icon.open {
      transform: rotate(180deg);
    }

    /* Improved email input style */
    .email-input {
      width: 100%;
      border-radius: 0.75rem;
      border: 2px solid #3b82f6;
      background: white;
      padding: 1rem 1.25rem;
      font-weight: 600;
      transition: all 0.3s ease;
      font-size: 1rem;
    }
    .email-input::placeholder {
      color: #94a3b8;
      font-weight: 500;
    }
    .email-input:hover {
      border-color: #2563eb;
    }
    .email-input:focus {
      outline: none;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
      border-color: #2563eb;
    }

    /* Resend buttons style to match nav buttons */
    .resend-btn {
      background-color: transparent;
      border: 2px solid #3b82f6;
      color: #3b82f6;
      font-weight: 700;
      transition: all 0.3s ease;
      border-radius: 0.75rem;
      padding: 0.75rem 1.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      width: 100%;
      margin-bottom: 1rem;
    }
    .resend-btn:hover, .resend-btn:focus {
      background: #3b82f6;
      color: #ffffff;
      box-shadow: 0 0 10px #3b82f6;
      outline: none;
      transform: translateY(-3px);
    }
    .resend-btn i {
      transition: transform 0.3s ease;
    }
    .resend-btn:hover i, .resend-btn:focus i {
      transform: scale(1.1);
    }

    /* New styles for action buttons */
    .action-btn {
      background-color: transparent;
      border: 2px solid #3b82f6;
      color: #3b82f6;
      font-weight: 700;
      transition: all 0.3s ease;
      border-radius: 0.5rem;
      padding: 0.5rem 1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      font-size: 0.875rem;
      margin-left: 0.5rem;
    }
    .action-btn:hover, .action-btn:focus {
      background: #3b82f6;
      color: #ffffff;
      box-shadow: 0 0 5px #3b82f6;
      outline: none;
    }
    .action-btn.copy-btn {
      border-color: #10b981;
      color: #10b981;
    }
    .action-btn.copy-btn:hover, .action-btn.copy-btn:focus {
      background: #10b981;
      color: #ffffff;
      box-shadow: 0 0 5px #10b981;
    }
    .status-badge {
      font-weight: 600;
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      font-size: 0.875rem;
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
    }
    .status-badge.pending {
      background-color: #fef3c7;
      color: #d97706;
    }
    .status-badge.paid {
      background-color: #d1fae5;
      color: #059669;
    }
    .status-badge.expired {
      background-color: #fee2e2;
      color: #dc2626;
    }
    .history-content {
      flex-grow: 1;
    }
    .history-actions {
      display: flex;
      align-items: center;
    }

    /* Adjusted heading sizes */
    .section-heading {
      font-size: 1.5rem;
      margin-bottom: 1.5rem;
    }
    .refresh-btn {
      font-size: 0.875rem;
    }
  </style>
</head>
<body>
  <div class="max-w-5xl mx-auto px-5 py-8">
    <nav aria-label="Primary Navigation" class="rounded-2xl mb-10 shadow-lg flex flex-col md:flex-row md:justify-between md:items-center p-5 gap-4 border border-[#3b82f6]">
      <div aria-label="OneClash Store Logo" class="text-[#3b82f6] text-2xl font-extrabold flex items-center gap-3 select-none">
        <img alt="Blue WiFi signal icon with modern style" class="w-10 h-10" height="40" src="https://storage.googleapis.com/a1aa/image/580b01e3-79b8-4d53-6a75-b6018e439e9b.jpg" width="40"/>
        <span>OneClash Store</span>
      </div>
      <div aria-label="Navigation Buttons" class="flex flex-wrap gap-4 justify-center md:justify-start" id="navButtons" role="navigation"></div>
    </nav>

    <!-- Home Page -->
    <section aria-label="Halaman Beli Voucher" class="page block space-y-10" id="homePage" tabindex="-1">
      <article aria-label="Pilih Paket WiFi" class="card p-8 relative">
        <h2 class="section-heading font-extrabold select-none flex items-center gap-4 text-[#2563eb]">
          <i class="fas fa-gift"></i>
          Pilih Paket WiFi
        </h2>
        <form class="space-y-8" id="purchaseForm" novalidate="">
          <div class="relative">
            <label class="block mb-3 text-lg font-semibold select-none text-[#2563eb]" for="duration">
              <i class="fas fa-calendar-alt"></i>
              Durasi Paket
            </label>

            <!-- Improved Radio Dropdown -->
            <div class="duration-dropdown" x-data="{
              open: false,
              selected: '1',
              options: [
                { value: '1', label: '6 Jam', price: 'Rp 20,000' },
                { value: '2', label: '12 Jam', price: 'Rp 30,000' },
                { value: '3', label: '3 Hari', price: 'Rp 60,000' },
                { value: '4', label: '7 Hari', price: 'Rp 100,000' },
                { value: '5', label: '30 Hari', price: 'Rp 350,000' }
              ],
              get selectedOption() {
                return this.options.find(opt => opt.value === this.selected);
              }
            }">
              <button 
                @click="open = !open"
                type="button"
                class="dropdown-button"
                aria-haspopup="listbox"
                :aria-expanded="open"
              >
                <span x-text="selectedOption ? selectedOption.label : 'Pilih Durasi'"></span>
                <i class="fas fa-chevron-down text-[#3b82f6] dropdown-icon" :class="{ 'open': open }"></i>
              </button>

              <div 
                x-show="open"
                class="duration-options"
                role="listbox"
                @click.outside="open = false"
              >
                <template x-for="option in options" :key="option.value">
                  <div 
                    @click="selected = option.value; open = false"
                    class="duration-option"
                    :class="{ 'selected': selected === option.value }"
                    role="option"
                    :aria-selected="selected === option.value"
                  >
                    <div class="custom-radio">
                      <div class="custom-radio-inner"></div>
                    </div>
                    <div>
                      <div class="duration-label" x-text="option.label"></div>
                      <div class="duration-price" x-text="option.price"></div>
                    </div>
                  </div>
                </template>
              </div>

              <input type="hidden" name="duration" id="duration" x-model="selected">
            </div>
          </div>

          <div>
            <label class="block mb-3 text-lg font-semibold select-none text-[#2563eb]" for="email">
              <i class="fas fa-envelope"></i>
              Email Pembeli
            </label>
            <!-- Improved Email Input -->
            <input 
              aria-describedby="emailHelp" 
              autocomplete="email" 
              class="email-input" 
              id="email" 
              placeholder="contoh@email.com" 
              required="" 
              type="email"
            />
            <p class="mt-1 location-text select-none" id="emailHelp">
              Pastikan email Anda benar untuk menerima voucher.
            </p>
          </div>

          <button aria-live="polite" class="btn-primary w-full py-5 flex justify-center items-center gap-4 rounded-xl" type="submit">
            <span id="loadText">
              <i class="fas fa-credit-card"></i>
              Bayar Sekarang
            </span>
            <div aria-hidden="true" class="loader border-4 border-white border-t-transparent rounded-full w-7 h-7 hidden" id="loader"></div>
          </button>
        </form>
      </article>

      <article aria-label="Lokasi Offline" class="card p-8 relative">
        <h3 class="section-heading font-extrabold select-none flex items-center gap-3 text-[#2563eb]">
          <i class="fas fa-map-marker-alt"></i>
          Lokasi Offline
        </h3>
        <div class="grid gap-4 text-[#475569] text-sm font-medium select-none">
          <div aria-label="Lokasi Jl. Merdeka No. 123 Jakarta Pusat" class="flex items-center gap-3 location-text">
            <i class="fas fa-map-marker-alt text-[#3b82f6]"></i>
            <strong>Jl. Merdeka No. 123</strong> - Jakarta Pusat
          </div>
          <div aria-label="Lokasi Mall Central Park Lt. 5 Food Court" class="flex items-center gap-3 location-text">
            <i class="fas fa-map-marker-alt text-[#3b82f6]"></i>
            <strong>Mall Central Park</strong> - Lt. 5 Food Court
          </div>
          <div aria-label="Lokasi Pluit Village Area Gaming Zone" class="flex items-center gap-3 location-text">
            <i class="fas fa-map-marker-alt text-[#3b82f6]"></i>
            <strong>Pluit Village</strong> - Area Gaming Zone
          </div>
        </div>
      </article>
    </section>

    <!-- History Page -->
    <section aria-label="Riwayat Pembelian" class="page hidden" id="historyPage" tabindex="-1">
      <article class="card p-8 relative">
        <h2 class="section-heading font-extrabold select-none flex items-center gap-4 text-[#2563eb]">
          <i class="fas fa-history"></i>
          Riwayat Pembelian
        </h2>
        <div class="flex justify-end mb-6">
          <button aria-label="Refresh Status Riwayat" class="nav-btn rounded-corners px-6 py-3 flex items-center gap-3 refresh-btn" id="refreshHistoryBtn">
            <i class="fas fa-sync-alt"></i>
            Refresh Status
          </button>
        </div>
        <div aria-live="polite" aria-relevant="additions" class="grid gap-4" id="historyList" role="list"></div>
      </article>
    </section>
  </div>

  <!-- QR Modal -->
  <div aria-labelledby="qrModalTitle" aria-modal="true" class="modal fixed inset-0 bg-black bg-opacity-80 flex justify-center items-center z-50 hidden" id="qrModal" role="dialog">
    <div class="modal-content animate-scaleIn" style="animation: modalIn 0.3s ease forwards">
      <h3 class="select-none flex justify-center items-center gap-3" id="qrModalTitle">
        <i class="fas fa-qrcode text-[#2563eb]"></i>
        Scan QR Pembayaran
      </h3>
      <img alt="QR Code for payment scanning" class="w-64 h-64 mx-auto my-6 object-contain rounded-xl border-2 border-[#3b82f6] shadow-lg" id="qrImage" src=""/>
      <div aria-live="polite" class="mb-6 text-lg font-semibold select-none text-center text-[#475569]" id="paymentStatus"></div>
      <button aria-label="Kirim ulang QRIS ke email" class="resend-btn" id="resendQrisBtn">
        <i class="fas fa-envelope"></i>
        Kirim Ulang QRIS ke Email
      </button>
      <div class="text-center text-sm font-semibold select-none min-h-[1.25rem]" id="resendMessage"></div>
      <button aria-label="Tutup modal QR pembayaran" class="nav-btn rounded-corners w-full py-3 flex items-center justify-center gap-3" onclick="closeModal()">
        <i class="fas fa-times"></i>
        Tutup
      </button>
    </div>
  </div>

  <!-- Voucher Modal -->
  <div aria-labelledby="voucherModalTitle" aria-modal="true" class="modal fixed inset-0 bg-black bg-opacity-80 flex justify-center items-center z-50 hidden" id="voucherModal" role="dialog">
    <div class="modal-content animate-scaleIn" style="animation: modalIn 0.3s ease forwards">
      <h3 class="select-none flex justify-center items-center gap-3" id="voucherModalTitle">
        <i class="fas fa-ticket-alt text-[#2563eb]"></i>
        Kode Voucher Anda
      </h3>
      <div aria-live="polite" class="text-4xl font-mono font-extrabold text-[#1e40af] mb-8 select-all break-words text-center" id="voucherCode"></div>
      <button aria-label="Kirim ulang voucher ke email" class="resend-btn" id="resendVoucherBtn">
        <i class="fas fa-envelope"></i>
        Kirim Ulang Voucher ke Email
      </button>
      <div class="text-center text-sm font-semibold select-none min-h-[1.25rem]" id="resendVoucherMessage"></div>
      <button aria-label="Tutup modal kode voucher" class="nav-btn rounded-corners w-full py-3 flex items-center justify-center gap-3" onclick="closeVoucherModal()">
        <i class="fas fa-times"></i>
        Tutup
      </button>
    </div>
  </div>

  <footer class="text-center py-8 text-[#64748b] select-none">
    <p>
      âœ¨ Dikembangkan dengan
      <i class="fas fa-heart text-[#ef4444]"></i>
      oleh
      <strong>OnclDev X ZarCode</strong>
    </p>
  </footer>

  <script>
    const API_BASE = 'https://vwproject-production.up.railway.app';
    let currentTransactionId = null;
    let currentTransactionEmail = null;

    // Page Navigation
    const pages = {
      home: document.getElementById('homePage'),
      history: document.getElementById('historyPage'),
    };

    const navButtonsContainer = document.getElementById('navButtons');

    // Buttons definitions
    const btnBuyVoucher = document.createElement('button');
    btnBuyVoucher.type = 'button';
    btnBuyVoucher.className = "nav-btn rounded-corners";
    btnBuyVoucher.setAttribute('aria-label', 'Beli Voucher');
    btnBuyVoucher.innerHTML = '<i class="fas fa-shopping-cart"></i> Beli Voucher';
    btnBuyVoucher.addEventListener('click', () => showPage('home'));

    const btnHistory = document.createElement('button');
    btnHistory.type = 'button';
    btnHistory.className = "nav-btn rounded-corners";
    btnHistory.setAttribute('aria-label', 'Riwayat');
    btnHistory.innerHTML = '<i class="fas fa-history"></i> Riwayat';
    btnHistory.addEventListener('click', () => showPage('history'));

    function updateNavButtons(pageId) {
      navButtonsContainer.innerHTML = '';
      if (pageId === 'home') {
        navButtonsContainer.appendChild(btnHistory);
      } else if (pageId === 'history') {
        navButtonsContainer.appendChild(btnBuyVoucher);
      }
    }

    function showPage(pageId) {
      Object.values(pages).forEach((page) => (page.style.display = 'none'));
      pages[pageId].style.display = 'block';
      pages[pageId].focus?.();

      updateNavButtons(pageId);

      if (pageId === 'history') loadHistory();
    }

    // Modal Handling
    function showModal(modalId) {
      document.getElementById(modalId).classList.remove('hidden');
      document.getElementById(modalId).classList.add('flex');
    }

    function closeModal() {
      document.querySelectorAll('.modal').forEach((modal) => {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
      });
      const resendBtn = document.getElementById('resendQrisBtn');
      resendBtn.disabled = false;
      resendBtn.innerHTML = '<i class="fas fa-envelope"></i> Kirim Ulang QRIS ke Email';
      document.getElementById('paymentStatus').textContent = '';
      document.getElementById('resendMessage').textContent = '';
      currentTransactionId = null;
      currentTransactionEmail = null;
    }

    function closeVoucherModal() {
      const voucherModal = document.getElementById('voucherModal');
      voucherModal.classList.add('hidden');
      voucherModal.classList.remove('flex');
      const resendVoucherBtn = document.getElementById('resendVoucherBtn');
      resendVoucherBtn.disabled = false;
      resendVoucherBtn.innerHTML = '<i class="fas fa-envelope"></i> Kirim Ulang Voucher ke Email';
      document.getElementById('resendVoucherMessage').textContent = '';
      currentTransactionId = null;
      currentTransactionEmail = null;
    }

    // Purchase Handling
    const purchaseForm = document.getElementById('purchaseForm');
    purchaseForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const loader = document.getElementById('loader');
      const loadText = document.getElementById('loadText');
      const formData = {
        type: document.getElementById('duration').value,
        email: document.getElementById('email').value.trim(),
      };

      loader.classList.remove('hidden');
      loadText.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Memproses...';

      try {
        const response = await fetch(`${API_BASE}/api/generate-qr`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(formData),
        });

        const data = await response.json();

        if (response.ok) {
          currentTransactionId = data.transactionId;
          currentTransactionEmail = formData.email;
          showModal('qrModal');
          const qrImage = document.getElementById('qrImage');
          qrImage.src = data.qrUrl;
          qrImage.alt = `QR Code for payment of transaction ${data.transactionId}`;
          document.getElementById('paymentStatus').textContent = 'ðŸ”„ Memeriksa status pembayaran...';
          document.getElementById('resendMessage').textContent = '';
          checkPaymentStatus();
          saveToHistory(data);
        } else {
          alert(`Error: ${data.error}`);
        }
      } catch (error) {
        alert('Terjadi kesalahan jaringan');
      } finally {
        loader.classList.add('hidden');
        loadText.innerHTML = '<i class="fas fa-credit-card"></i> Bayar Sekarang';
      }
    });

    async function checkPaymentStatus() {
      const statusElement = document.getElementById('paymentStatus');
      if (!currentTransactionId) return;

      try {
        const response = await fetch(`${API_BASE}/api/check-status/${currentTransactionId}`);
        const data = await response.json();

        if (data.status === 'paid') {
          statusElement.textContent = 'âœ… Pembayaran berhasil!';
          updateHistoryStatus(currentTransactionId, 'Paid');
          const voucher = await getVoucher();
          closeModal();
          showVoucherModal(voucher);
        } else if (data.status === 'expired') {
          statusElement.textContent = 'âŒ Pembayaran kedaluwarsa';
          updateHistoryStatus(currentTransactionId, 'Expired');
        } else {
          setTimeout(checkPaymentStatus, 3000);
        }
      } catch (error) {
        statusElement.textContent = 'âš ï¸ Gagal memeriksa status';
      }
    }

    async function getVoucher() {
      try {
        const response = await fetch(`${API_BASE}/api/get-voucher/${currentTransactionId}`);
        const data = await response.json();
        updateHistoryStatus(currentTransactionId, 'Paid');
        return data.voucher;
      } catch (error) {
        return 'Gagal mendapatkan voucher';
      }
    }

    function showVoucherModal(voucherCode) {
      const voucherModal = document.getElementById('voucherModal');
      const voucherCodeDiv = document.getElementById('voucherCode');
      voucherCodeDiv.textContent = voucherCode;
      showModal('voucherModal');
    }

    // History Handling
    function saveToHistory(data) {
      const history = JSON.parse(localStorage.getItem('purchaseHistory')) || [];
      history.push({
        id: data.transactionId,
        amount: data.amount,
        email: data.email,
        date: new Date().toISOString(), // Simpan sebagai ISO string untuk sorting yang lebih mudah
        status: 'Pending',
        qrUrl: data.qrUrl
      });
      localStorage.setItem('purchaseHistory', JSON.stringify(history));
      loadHistory();
    }

    function updateHistoryStatus(transactionId, newStatus) {
      const history = JSON.parse(localStorage.getItem('purchaseHistory')) || [];
      const idx = history.findIndex((item) => item.id === transactionId);
      if (idx !== -1) {
        if (newStatus.toLowerCase() === 'paid') {
          history[idx].status = 'Paid';
          localStorage.setItem('purchaseHistory', JSON.stringify(history));
          loadHistory();
        } else if (history[idx].status.toLowerCase() !== 'paid') {
          history[idx].status = newStatus;
          localStorage.setItem('purchaseHistory', JSON.stringify(history));
          loadHistory();
        }
      }
    }

    async function checkAllTransactionsStatus() {
      const history = JSON.parse(localStorage.getItem('purchaseHistory')) || [];
      const pendingTransactions = history.filter(item => item.status.toLowerCase() === 'pending');

      for (const transaction of pendingTransactions) {
        try {
          const response = await fetch(`${API_BASE}/api/check-status/${transaction.id}`);
          const data = await response.json();

          if (data.status === 'paid') {
            updateHistoryStatus(transaction.id, 'Paid');
          } else if (data.status === 'expired') {
            updateHistoryStatus(transaction.id, 'Expired');
          }
        } catch (error) {
          console.error(`Error checking status for transaction ${transaction.id}:`, error);
        }
      }

      loadHistory();
    }

    async function loadHistory() {
      let history = JSON.parse(localStorage.getItem('purchaseHistory')) || [];
      const historyList = document.getElementById('historyList');

      if (history.length === 0) {
        historyList.innerHTML =
          '<p class="text-center text-[#64748b] select-none">Belum ada riwayat pembelian.</p>';
        return;
      }

      // Sort history by date (newest first)
      history = history.sort((a, b) => new Date(b.date) - new Date(a.date));

      historyList.innerHTML = history
        .map(
          (item) => `
          <div
            class="history-item"
            role="listitem"
            tabindex="0"
            aria-label="Transaksi ${item.id} dengan email ${item.email} dan status ${item.status}"
            data-id="${item.id}"
            data-status="${item.status.toLowerCase()}"
            data-qrurl="${item.qrUrl || ''}"
            data-email="${item.email}"
          >
            <div class="history-content">
              <strong class="block text-lg">${item.id}</strong>
              <span class="text-sm text-[#475569]">${item.email} - Rp ${item.amount}</span>
              <time class="block text-xs text-[#94a3b8] mt-1">${new Date(item.date).toLocaleString()}</time>
            </div>
            <div class="history-actions">
              <div class="status-badge ${item.status.toLowerCase()}">
                ${item.status}
              </div>
              ${item.status.toLowerCase() === 'paid' ? 
                `<button class="action-btn copy-btn" data-id="${item.id}" aria-label="Salin voucher">
                  <i class="fas fa-copy"></i>
                </button>` : ''}
            </div>
          </div>
        `
        )
        .join('');

      // Add event listeners for copy buttons
      document.querySelectorAll('.copy-btn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          e.stopPropagation();
          const transactionId = btn.getAttribute('data-id');
          try {
            const response = await fetch(`${API_BASE}/api/get-voucher/${transactionId}`);
            const data = await response.json();

            if (data.voucher) {
              navigator.clipboard.writeText(data.voucher).then(() => {
                const originalContent = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-check"></i>';
                btn.disabled = true;
                setTimeout(() => {
                  btn.innerHTML = originalContent;
                  btn.disabled = false;
                }, 2000);
              });
            } else {
              alert('Gagal mendapatkan voucher untuk disalin');
            }
          } catch (error) {
            alert('Terjadi kesalahan saat menyalin voucher');
          }
        });
      });

      document.querySelectorAll('.history-item').forEach((el) => {
        el.addEventListener('click', async () => {
          const status = el.getAttribute('data-status').toLowerCase();
          const transactionId = el.getAttribute('data-id');
          const email = el.getAttribute('data-email');

          if (status === 'pending') {
            try {
              const statusResponse = await fetch(`${API_BASE}/api/check-status/${transactionId}`);
              const statusData = await statusResponse.json();

              if (statusData.status === 'paid') {
                updateHistoryStatus(transactionId, 'Paid');
                const voucher = await fetchVoucherForHistory(transactionId);
                if (voucher) {
                  currentTransactionId = transactionId;
                  currentTransactionEmail = email;
                  showVoucherModal(voucher);
                  return;
                }
              }
            } catch (error) {
              console.error("Error checking status:", error);
            }

            const qrUrl = el.getAttribute('data-qrurl');
            if (qrUrl) {
              currentTransactionId = transactionId;
              currentTransactionEmail = email;
              showModal('qrModal');
              const qrImage = document.getElementById('qrImage');
              qrImage.src = qrUrl;
              qrImage.alt = `QR Code for payment of transaction ${currentTransactionId}`;
              const paymentStatus = document.getElementById('paymentStatus');
              paymentStatus.textContent = 'ðŸ”„ Memeriksa status pembayaran...';
              document.getElementById('resendMessage').textContent = '';
              checkPaymentStatus();
            } else {
              alert('QR Code tidak tersedia untuk transaksi ini.');
            }
          } else if (status === 'paid') {
            currentTransactionId = transactionId;
            currentTransactionEmail = email;
            const voucher = await fetchVoucherForHistory(transactionId);
            if (voucher) {
              showVoucherModal(voucher);
              document.getElementById('resendVoucherMessage').textContent = '';
            } else {
              alert('Gagal mendapatkan kode voucher.');
            }
          }
        });
        el.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            el.click();
          }
        });
      });
    }

    async function fetchVoucherForHistory(transactionId) {
      try {
        const response = await fetch(`${API_BASE}/api/get-voucher/${transactionId}`);
        if (!response.ok) return null;
        const data = await response.json();

        if (data.voucher) {
          updateHistoryStatus(transactionId, 'Paid');
        }

        return data.voucher || null;
      } catch {
        return null;
      }
    }

    // Resend QRIS Email Button Handling
    const resendQrisBtn = document.getElementById('resendQrisBtn');
    const resendMessage = document.getElementById('resendMessage');
    resendQrisBtn.addEventListener('click', async () => {
      if (!currentTransactionId) return;
      resendQrisBtn.disabled = true;
      resendQrisBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Mengirim ulang...';
      resendMessage.textContent = '';
      resendMessage.classList.remove('text-green-600', 'text-red-600');

      try {
        const response = await fetch(`${API_BASE}/api/resend-qris-email/${currentTransactionId}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
        });
        const data = await response.json();
        if (response.ok && data.success) {
          resendMessage.textContent = 'Berhasil kirim qris ke email';
          resendMessage.classList.add('text-green-600');
        } else {
          resendMessage.textContent = 'Gagal mengirim qris ke email';
          resendMessage.classList.add('text-red-600');
        }
      } catch (error) {
        resendMessage.textContent = 'Gagal mengirim qris ke email';
        resendMessage.classList.add('text-red-600');
      } finally {
        resendQrisBtn.disabled = false;
        resendQrisBtn.innerHTML = '<i class="fas fa-envelope"></i> Kirim Ulang QRIS ke Email';
      }
    });

    // Resend Voucher Email Button Handling
    const resendVoucherBtn = document.getElementById('resendVoucherBtn');
    const resendVoucherMessage = document.getElementById('resendVoucherMessage');
    resendVoucherBtn.addEventListener('click', async () => {
      if (!currentTransactionId) return;
      resendVoucherBtn.disabled = true;
      resendVoucherBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Mengirim ulang...';
      resendVoucherMessage.textContent = '';
      resendVoucherMessage.classList.remove('text-green-600', 'text-red-600');

      try {
        const response = await fetch(`${API_BASE}/api/resend-voucher-email/${currentTransactionId}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
        });
        const data = await response.json();
        if (response.ok && data.success) {
          resendVoucherMessage.textContent = 'Berhasil kirim voucher ke email';
          resendVoucherMessage.classList.add('text-green-600');
        } else {
          resendVoucherMessage.textContent = 'Gagal mengirim voucher ke email';
          resendVoucherMessage.classList.add('text-red-600');
        }
      } catch (error) {
        resendVoucherMessage.textContent = 'Gagal mengirim voucher ke email';
        resendVoucherMessage.classList.add('text-red-600');
      } finally {
        resendVoucherBtn.disabled = false;
        resendVoucherBtn.innerHTML = '<i class="fas fa-envelope"></i> Kirim Ulang Voucher ke Email';
      }
    });

    // Refresh Status Button Handling
    const refreshHistoryBtn = document.getElementById('refreshHistoryBtn');
    refreshHistoryBtn.addEventListener('click', async () => {
      refreshHistoryBtn.disabled = true;
      refreshHistoryBtn.classList.add('opacity-50', 'cursor-not-allowed');
      refreshHistoryBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Memperbarui...';

      try {
        await checkAllTransactionsStatus();
      } catch (error) {
        console.error('Error refreshing history status:', error);
      } finally {
        refreshHistoryBtn.disabled = false;
        refreshHistoryBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        refreshHistoryBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh Status';
      }
    });

    // Initial Load
    loadHistory();
    showPage('home');
  </script>
</body>
</html>